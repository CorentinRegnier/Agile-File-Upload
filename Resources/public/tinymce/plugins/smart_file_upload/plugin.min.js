tinymce.PluginManager.requireLangPack('agile_image_upload', 'fr_FR');
tinymce.PluginManager.add("agile_image_upload", function (editor, t) {
    var token = editor.getParam("session_token"),
        path = editor.getParam("image_upload_path"),
        _window;


    function browse() {
        var $file = $('<input type="file" accept="image/jpeg,image/png,image/gif"/>');

        $file.fileupload({
            dataType: 'json',
            url: path,
            formData: {
                'file[_token]': token
            },
            paramName: 'file[file][file]'
        })
            .on('fileuploadadd', function (e, data) {
                data.submit();
                editor.setProgressState(true, 200);
            })
            .on('fileuploadprogress', function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
            })
            .on('fileuploaddone', function (e, data) {
                file = data.result.file;
                var image = new Image();
                image.onload = function () {
                    editor.selection.setContent(editor.dom.createHTML("img", {
                        src: file.url
                    }));
                    editor.setProgressState(false);
                };
                image.src = file.url;
            })
            .on('fileuploadfail', function (e, data) {
                editor.setProgressState(false);
                var r = data.response().jqXHR.responseJSON;
                if (r.errors) {
                    editor.windowManager.alert(r.errors.join('<br>'))
                }
            });

        if ($('html').is('.ie9, .ltie9')) {
            var id = editor.id + '_agile_image_upload';
            $('#' + id).remove();
            $file.attr('id', id);
            $file.hide()
            $file.on('fileuploadadd', function () {
                editor.windowManager.close();
            })
            $(editor.targetElm).after($file);
            editor.windowManager.open({
                title: 'Upload an image',
                body: [{
                    type: 'container',
                    html: '<label class="ag-fileupload-browse-ltie10" for="' + id + '">' + tinymce.util.I18n.translate('Browse') + '</label>'
                }],
                buttons: [{
                    text: 'Cancel',
                    onclick: function () {
                        editor.windowManager.close()
                    }
                }]
            });
        } else {
            $file.trigger('click');
        }
    }

    editor.addButton("agile_image_upload", {
        tooltip: "Upload an image",
        icon: "image",
        text: "Upload",
        onclick: function () {
            browse();
        }
    });
});
